---
version: "0.1"

include:
  - "foo.yml"
  - "https://foo.yml"

services:

  db-master:
    image: postgres
    expose:
      - port: 5432
        proto: tcp
        to:
          - service: db-pool
          - service: db-pool
            global:  true
          - service: db-slave
            global: true

  db-slave:
    image: postgres-slave
    depends-on:
      - service: db-master
    expose:
      - port: 5432
        proto: tcp
        to:
          - service: db-pool

  db-pool:
    image: db-pool
    depends-on:
      - service: db-slave
      - service: db-master
    expose:
      - port: 5432
        proto: tcp
        to:
          - service: web

  web:
    image: foo:latest
    port: 80
    depends-on:
      - service: db-pool
    expose:
      - port: 80
        to:
          global: true
      - port: 443
        to:
          global: true

deployment:

  infrastructure:

    westcoast:
      region: us-west
      profiles:
        web:
          compute:
            cpu: 2
            memory: 3GB
            disk: 5GB
          pricing:
            max-price: 5
            collateral: 1h
        db:
          compute:
            cpu: 10
            memory: 10GB
            disk: 5GB
          pricing:
            max-price: 10
            collateral: 30d

    eastcoast:
      region: us-east
      profiles:
        web:
          compute:
            cpu: 2
            memory: 3GB
            disk: 5GB
          pricing:
            max-price: 5
            collateral: 1h
        db:
          compute:
            cpu: 10
            memory: 10GB
            disk: 5GB
          pricing:
            max-price: 10
            collateral: 30d

  workloads:

    db-master:
      westcoast:
        profile: db
        nodes: 1

    db-slave:
      westcoast:
        profile: db
        nodes: 1
      eastcoast:
        profile: db
        nodes: 1

    db-pool:
      westcoast:
        profile: db-pool
        nodes: 10
      eastcoast:
        profile: db-pool
        nodes: 5

    web:
      westcoast:
        profile: web
        nodes: 20
      eastcoast:
        profile: web
        nodes: 10
